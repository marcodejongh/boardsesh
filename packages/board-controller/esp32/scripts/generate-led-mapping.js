#!/usr/bin/env node

/**
 * Generate LED position to placement ID mapping for ESP32
 *
 * This script reads the LED_PLACEMENTS data and generates a C++ header file
 * with the reverse mapping (LED position → placement ID) for a specific board configuration.
 *
 * Usage: node generate-led-mapping.js [boardName] [layoutId] [sizeId]
 * Example: node generate-led-mapping.js kilter 1 7
 */

const fs = require('fs');
const path = require('path');

// Read the LED placements TypeScript file and extract the data
function extractLedPlacements() {
  const filePath = path.join(__dirname, '../../../web/app/lib/__generated__/led-placements-data.ts');
  const content = fs.readFileSync(filePath, 'utf8');

  // Find the start of the object after LED_PLACEMENTS declaration
  const startMatch = content.match(/export const LED_PLACEMENTS[^{]*\{/);
  if (!startMatch) {
    throw new Error('Could not find LED_PLACEMENTS in file');
  }

  const startIndex = startMatch.index + startMatch[0].length - 1;

  // Find matching closing brace
  let braceCount = 1;
  let endIndex = startIndex + 1;
  while (braceCount > 0 && endIndex < content.length) {
    if (content[endIndex] === '{') braceCount++;
    if (content[endIndex] === '}') braceCount--;
    endIndex++;
  }

  let objStr = content.substring(startIndex, endIndex);

  // Clean up TypeScript syntax
  objStr = objStr.replace(/as\s+const/g, '');

  // Use Function constructor to evaluate (safer than eval)
  const fn = new Function('return ' + objStr);
  return fn();
}

function generateHeader(boardName, layoutId, sizeId) {
  const placements = extractLedPlacements();

  const key = `${layoutId}-${sizeId}`;
  const boardData = placements[boardName];

  if (!boardData) {
    console.error(`Board "${boardName}" not found. Available: ${Object.keys(placements).join(', ')}`);
    process.exit(1);
  }

  const layoutData = boardData[key];
  if (!layoutData) {
    console.error(`Layout "${key}" not found for ${boardName}. Available: ${Object.keys(boardData).join(', ')}`);
    process.exit(1);
  }

  // Create reverse mapping: ledPosition -> placementId
  const reverseMap = {};
  let maxLedPosition = 0;

  for (const [placementId, ledPosition] of Object.entries(layoutData)) {
    reverseMap[ledPosition] = parseInt(placementId, 10);
    maxLedPosition = Math.max(maxLedPosition, ledPosition);
  }

  const mappingCount = Object.keys(reverseMap).length;

  // Generate C++ header
  const header = `#ifndef LED_PLACEMENT_MAP_H
#define LED_PLACEMENT_MAP_H

/**
 * ⚠️ AUTO-GENERATED FILE - DO NOT EDIT MANUALLY ⚠️
 *
 * Generated by: scripts/generate-led-mapping.js
 * Board: ${boardName}
 * Layout ID: ${layoutId}
 * Size ID: ${sizeId}
 *
 * This file maps LED positions (index in LED strip) to placement IDs (hold IDs).
 * Used to convert LED commands from Bluetooth into frames strings for climb matching.
 */

#include <Arduino.h>

// Board configuration this mapping is for
#define LED_MAP_BOARD_NAME "${boardName}"
#define LED_MAP_LAYOUT_ID ${layoutId}
#define LED_MAP_SIZE_ID ${sizeId}

// Maximum LED position in this mapping
#define LED_MAP_MAX_POSITION ${maxLedPosition}

// Number of valid LED positions
#define LED_MAP_COUNT ${mappingCount}

/**
 * Sparse lookup table: LED position -> placement ID
 * Uses a std::map for efficiency with sparse data
 */
#include <map>

inline const std::map<uint16_t, uint16_t>& getLedToPlacementMap() {
    static const std::map<uint16_t, uint16_t> ledToPlacement = {
${Object.entries(reverseMap)
    .sort(([a], [b]) => parseInt(a) - parseInt(b))
    .map(([ledPos, placementId]) => `        {${ledPos}, ${placementId}}`)
    .join(',\n')}
    };
    return ledToPlacement;
}

/**
 * Convert LED position to placement ID
 * @param ledPosition The LED position (index in LED strip)
 * @return The placement ID, or 0 if not found
 */
inline uint16_t ledPositionToPlacementId(uint16_t ledPosition) {
    const auto& map = getLedToPlacementMap();
    auto it = map.find(ledPosition);
    if (it != map.end()) {
        return it->second;
    }
    return 0; // Not found
}

#endif // LED_PLACEMENT_MAP_H
`;

  return header;
}

// Main
const args = process.argv.slice(2);
const boardName = args[0] || 'kilter';
const layoutId = parseInt(args[1], 10) || 1;
const sizeId = parseInt(args[2], 10) || 7;

console.log(`Generating LED mapping for ${boardName} layout ${layoutId} size ${sizeId}...`);

try {
  const header = generateHeader(boardName, layoutId, sizeId);

  const outputPath = path.join(__dirname, '../src/config/led_placement_map.h');
  fs.writeFileSync(outputPath, header);

  console.log(`Generated: ${outputPath}`);
} catch (error) {
  console.error('Error:', error.message);
  process.exit(1);
}
