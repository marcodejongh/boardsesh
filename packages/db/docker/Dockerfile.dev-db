# =============================================================================
# Dockerfile.dev-db
# Multi-stage build that produces a PostgreSQL + PostGIS image with all
# Kilter/Tension board data pre-loaded and drizzle migrations applied.
# Developers just pull & run.
#
# Build context: packages/db/ (not packages/db/docker/) so we can access
# both docker/ scripts and drizzle/ migrations.
#
# Key trick: PGDATA is set to /var/lib/postgresql/pgdata (not the default
# /var/lib/postgresql/data) because the official postgres image declares a
# VOLUME on the default path, which discards data written during build.
# =============================================================================

# ---------------------------------------------------------------------------
# Stage 1: postgres + PostGIS base (same as Dockerfile.postgres)
# ---------------------------------------------------------------------------
FROM postgres:17 AS postgres-postgis

RUN apt-get update && \
    apt-get install -y --no-install-recommends postgresql-17-postgis-3 && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# ---------------------------------------------------------------------------
# Stage 2: Builder — download APKs, extract SQLite DBs, fix compat, import
# ---------------------------------------------------------------------------
FROM postgres-postgis AS builder

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      pgloader \
      sqlite3 \
      ca-certificates \
      curl \
      unzip \
      jq && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Custom PGDATA to avoid the VOLUME at /var/lib/postgresql/data
ENV PGDATA=/var/lib/postgresql/pgdata

# Copy pgloader configs and scripts (from docker/ subdirectory of build context)
COPY docker/cleanup_sqlite_db_problems.sh \
     docker/kilter_db.load docker/tension_db.load \
     docker/kilter_table_rename.sql docker/tension_table_rename.sql \
     /db/
RUN chmod +x /db/cleanup_sqlite_db_problems.sh

# Copy drizzle migration files (from drizzle/ subdirectory of build context)
COPY drizzle/ /drizzle/

# Single RUN: download → extract → fix → start PG → import → migrate → stop PG → clean
RUN set -e && \
    mkdir -p /db/tmp && \
    \
    # ── Download APKs ────────────────────────────────────────────────── \
    echo ">>> Downloading Kilterboard APK..." && \
    curl -o /tmp/kilterboard.apk -L \
      -A "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36" \
      "https://d.apkpure.net/b/APK/com.auroraclimbing.kilterboard?version=latest" && \
    echo ">>> Downloading Tensionboard APK..." && \
    curl -o /tmp/tensionboard.apk -L \
      -A "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36" \
      "https://d.apkpure.net/b/APK/com.auroraclimbing.tensionboard2?version=latest" && \
    \
    # ── Extract SQLite databases from APKs ───────────────────────────── \
    echo ">>> Extracting Kilter database..." && \
    unzip -o -j /tmp/kilterboard.apk assets/db.sqlite3 -d /db/tmp/ && \
    mv /db/tmp/db.sqlite3 /db/tmp/kilter.db && \
    \
    echo ">>> Extracting Tension database..." && \
    (unzip -o -j /tmp/tensionboard.apk assets/db.sqlite3 -d /db/tmp/ > /dev/null 2>&1 || \
     (echo ">>> Direct extraction failed, trying nested APK..." && \
      unzip -o -j /tmp/tensionboard.apk 'com.auroraclimbing.tensionboard2.apk' -d /tmp/ && \
      unzip -o -j /tmp/com.auroraclimbing.tensionboard2.apk assets/db.sqlite3 -d /db/tmp/)) && \
    { test -f /db/tmp/db.sqlite3 || \
      (echo "ERROR: Failed to extract Tension database from APK" && false); } && \
    mv /db/tmp/db.sqlite3 /db/tmp/tension.db && \
    \
    # ── Fix SQLite compatibility (FLOAT UNSIGNED → FLOAT, orphans) ──── \
    echo ">>> Fixing Kilter SQLite compatibility..." && \
    cp /db/tmp/kilter.db /db/tmp/kilter.modified.db && \
    cp /db/tmp/tension.db /db/tmp/tension.modified.db && \
    DB_FILE=/db/tmp/kilter.modified.db /db/cleanup_sqlite_db_problems.sh && \
    echo ">>> Fixing Tension SQLite compatibility..." && \
    DB_FILE=/db/tmp/tension.modified.db /db/cleanup_sqlite_db_problems.sh && \
    \
    # ── Initialize and start PostgreSQL ──────────────────────────────── \
    echo ">>> Initializing PostgreSQL..." && \
    mkdir -p "$PGDATA" && \
    chown postgres:postgres "$PGDATA" && \
    gosu postgres initdb -D "$PGDATA" --auth-local=trust --auth-host=trust && \
    gosu postgres pg_ctl -D "$PGDATA" start \
      -o "-c listen_addresses=localhost -c log_min_messages=warning" && \
    until gosu postgres pg_isready; do sleep 1; done && \
    \
    # ── Create database and neon proxy schema ────────────────────────── \
    echo ">>> Creating database 'main' and neon_control_plane schema..." && \
    gosu postgres psql postgres -c "CREATE DATABASE main" && \
    gosu postgres psql main -c "CREATE SCHEMA IF NOT EXISTS neon_control_plane" && \
    gosu postgres psql main -c "CREATE TABLE IF NOT EXISTS neon_control_plane.endpoints (endpoint_id VARCHAR(255) NOT NULL PRIMARY KEY, allowed_ips VARCHAR(255))" && \
    \
    # ── Import board data via pgloader ───────────────────────────────── \
    # pgloader uses {{DB_FILE}} / {{DB_URL}} mustache templates → env vars \
    # Must cd /db so AFTER LOAD EXECUTE ./kilter_table_rename.sql resolves \
    # FK constraint errors are expected (create no indexes → no PKs to reference) \
    export DB_URL="postgresql://postgres@localhost:5432/main" && \
    cd /db && \
    echo ">>> Importing Tension board data..." && \
    DB_FILE=/db/tmp/tension.modified.db pgloader /db/tension_db.load && \
    echo ">>> Importing Kilter board data..." && \
    DB_FILE=/db/tmp/kilter.modified.db pgloader /db/kilter_db.load && \
    \
    # ── Apply drizzle migrations via psql ─────────────────────────────── \
    # Replicate what drizzle-orm's migrate() does: create tracking table, \
    # apply each SQL file from the journal, record the SHA-256 hash. \
    echo ">>> Applying drizzle migrations..." && \
    gosu postgres psql main -c "CREATE TABLE IF NOT EXISTS \"__drizzle_migrations\" (id SERIAL PRIMARY KEY, hash text NOT NULL, created_at bigint)" && \
    for tag in $(jq -r '.entries[].tag' /drizzle/meta/_journal.json); do \
      sql_file="/drizzle/${tag}.sql"; \
      if [ -f "$sql_file" ]; then \
        hash=$(sha256sum "$sql_file" | cut -d' ' -f1); \
        echo "  Applying: $tag"; \
        gosu postgres psql main -f "$sql_file" && \
        gosu postgres psql main -c "INSERT INTO \"__drizzle_migrations\" (hash, created_at) VALUES ('$hash', $(date +%s)000)"; \
      else \
        echo "  WARNING: Migration file not found: $sql_file"; \
      fi; \
    done && \
    \
    # ── Stop PostgreSQL ──────────────────────────────────────────────── \
    echo ">>> Stopping PostgreSQL..." && \
    gosu postgres pg_ctl -D "$PGDATA" stop -m fast && \
    \
    # ── Clean up temporary files ─────────────────────────────────────── \
    rm -rf /db/tmp /tmp/*.apk /tmp/com.auroraclimbing.*.apk /drizzle && \
    echo ">>> Build complete — database is pre-populated with migrations applied."

# ---------------------------------------------------------------------------
# Stage 3: Final clean image with only the pre-populated PGDATA
# ---------------------------------------------------------------------------
FROM postgres-postgis

ENV PGDATA=/var/lib/postgresql/pgdata

COPY --from=builder --chown=postgres:postgres \
     /var/lib/postgresql/pgdata /var/lib/postgresql/pgdata
